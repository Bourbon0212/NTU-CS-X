---
title: "Data Visualization with ggplot2 (Part 1)"
author: "Bourbon0212"
date: "2018年7月17日"
output: html_document
---

* [Introduction](#1)    
* [Data](#2)    
* [Aesthetics](#3)    
* [Geometries](#4)
* [qplot and wrap-up](#5)

<h2 id = '1'></h2>
# **Introduction**

## Exploratory & Explanatory

* Explore: Confirm & Analysis -> Data
* Explain: Inform & Persuade  -> Reader

## Explore ggplot2
Compare teo graphs below, see what's the difference.
```{r}
library(ggplot2)
ggplot(mtcars, aes(x = cyl, y = mpg)) +
  geom_point()
ggplot(mtcars, aes(x = factor(cyl), y = mpg)) +
  geom_point()
```

The first plot is not quite right, because ggplot2 treats ```cyl``` as a continuous variable, and it gives the impression that there is such a thing as a 5 or 7-cylinder car, which there is not.   
After adding ```factor```, ggplot2 now treats ```cyl``` as a ```factor```. This time the x-axis does not contain variables like 5 or 7, only the values that are present in the dataset.   

## Grammar of Graphics    

* Principles
    + Graphics are made up of distinct layers of grammatical elements.    
    + Meaningful plots are built around appropriate aesthetic mappings.   
    + ggplot(```data```,```aes```) + ```geom``` + ```optional layers```
* Elements
    + 3 must have layers & 4 optional.    
    + Executed the command with ```+```.    
    *Required*
    + Data: The dataset being plotted.
    + Aesthetics: The scales onto which we ***map*** our data   
    + Geometries: The visual elements used for our data.    
    *Optional*
    + Facets: Plotting small multiples.
    + Statistics: Representations of our data to aid understanding.   
    + Coordinates: The space on which data will be plotted.
    + Themes: All none-data ink.
<div style="width:450px; height:300px">    
![](D:\Desktop\uname.jpg)
</div>

```{r}
ggplot(diamonds, aes(x = carat, y = price)) +
  geom_point(alpha = 0.2) +
  geom_smooth(aes(colour = clarity),se = F)#se -> 要不要顯示誤差範圍
```

<h2 id = '2'></h2>
# **Data**

## Base plot vs. ggplot2
* Base plot Limitation

    + Plot doesn't get redrawn.   
    + Plot is drawn as an image.    
    + Need to manually add legend.    
    + No unified framework for plotting.    

* Advantages of ggplot2   

    + Creates plotting objects, which can be manipulated
    + Takes care of a lot of the leg work for you, such as choosing nice color palettes and making legends.   
    + Built upon the grammar of graphics plotting philosophy, making it more flexible and intuitive for understanding the relationship between your visuals and your data.    
    
Let's see how complex it will be if we use the base plot().
```{r}
#Convert cyl to factor
mtcars$cyl <- as.factor(mtcars$cyl)
```
```{r eval = F}
#Example from base R
plot(mtcars$wt, mtcars$mpg, col = mtcars$cyl)
abline(lm(mpg ~ wt, data = mtcars), lty = 2)
lapply(mtcars$cyl, function(x) {
  abline(lm(mpg ~ wt, mtcars, subset = (cyl == x)), col = x)
  })
```
<div style="width:600px; height:400px">    
![](D:\Desktop\1.png) 
</div>
Now try with ggplot2 package.
```{r}
ggplot(mtcars, aes(x = wt, y = mpg, col = cyl)) +
  geom_point() + # Copy from Plot 2
  geom_smooth(method = 'lm', se = F) + # Copy from Plot 2
  geom_smooth(aes(group = 1),method = 'lm', se = F, linetype = 2)
```

## Tidy Data
### Reference: **[Cleaning Data in R](https://bourbon0212.github.io/NTU-CS-X/Week2/Cleaning_Data_in_R.html)**   

* **gather(```df```, ```key```, ```val```, ```-col```)**: Rearranges the data frame by specifying the columns that are categorical variables with a ```-``` notation.     
* **spread(```df```, ```key```, ```val```)**: Spread key-value pairs to columns.
* **separate(```df```, ```col```, ```into(c("col1", "col2"))```, sep = '')**: Separate one column into multiple.   
* **unite(```df```, ```col```, ...(bare names of columns), sep = '')**: Unite multiple columns into one.   

What kind of graph you want to plot determine how ypu tidy of ypur messy data.
```{r}
library(tidyr)
#iris.tidy
iris.tidy <- iris %>%
  gather(key, Value, -'Species') %>%
  separate(key, c("Part", "Measure"), "\\.")
head(iris.tidy)
ggplot(iris.tidy, aes(x = Species, y = Value, col = Part)) +
  geom_jitter() +
  facet_grid(. ~ Measure)

#iris.wide
iris$Flower <- 1:nrow(iris)
iris.wide <- iris %>%
  gather(key, value, -Species, -Flower) %>%
  separate(key, c('Part','Measure'), "\\.") %>%
  spread(Measure, value)
head(iris.wide)
ggplot(iris.wide, aes(x = Length, y = Width, color = Part)) +
  geom_jitter() +
  facet_grid(. ~ Species)
```

<h2 id = '3'></h2>
# **Aesthetics**

## Typical Aesthetics     

* ```x```: x-axis position.      
* ```y```: y_axis position.   
* ```colour```: colour of dots, outlines or other shapes.   
* ```fill```: fill colour. typically the inside shading.            
* ```size```: the diameter of points, the thickness of lines, and the font size of text.        
* ```alpha```: Transparency (0: transparent, 1: opaque)     
* ```linetype```: line dash patterns.     
* ```labels```:  text on a plot or axes.      
* ```shape```: shape of a point.

**A word about shapes**   
Shapes in R can have a value from 1-25. Shapes 1-20 can only accept a ```color``` aesthetic, but shapes 21-25 have both a ```color``` and a ```fill``` aesthetic.    

**A word about hexadecimal colours**    
Hexadecimal, literally "related to 16", is a base-16 alphanumeric counting system. Individual values come from the ranges 0-9 and A-F. This means there are 256 possible two-digit values (i.e. 00 - FF). Hexadecimal colours use this system to specify a six-digit code for Red, Green and Blue values (```"#RRGGBB"```).   

**Aesthetics and Attributes**   
All the visible aesthetics can serve as attributes and aesthetics. Variables in a data frame are mapped to ***aesthetics*** in ```aes()```. (e.g. ```aes(col = cyl))``` within ```ggplot()```. Visual elements are set by ***attributes*** in specific geom layers (```geom_point(col = "red")```).   
```{r}
# We're focusing on aesthetic mappings here.
ggplot(mtcars, aes(x = mpg, y = qsec, col = factor(cyl), shape = factor(am), size = (hp/wt))) +
  geom_point()
```

## Modify Aesthetics    

#### **Position**     
Position specifies how ggplot will adjust for overlapping bars or points in a single layer.   

* **identity**: *default in scatter plot.* The value in the data frame is exactly where the value will be positioned in the plot.     
* **jitter**:  Spread out points that would otherwise be overplotted.   
* **stack**: *default in bar plot.*    
* **dodge**: Principles of similarity and proximity   
* **fill**: Show proportion.    
* **jitterdodge**:    

#### **Scatter Plot: Jitter or Identity?**   
Jittering is adding a small amount of random noise to data. It is often used to spread out points that would otherwise be overplotted which means when one or more points are in the same place (or close enough to the same place) that you can't look at the plot and tell how many points are there.   

##### **```geom_jitter()``` works on small dataset**            
```{r}
plot <- ggplot(iris.wide, aes(x = Length, y = Width, color = Part, fill = Species))
  plot + geom_point(shape = 21, alpha = 0.3)
  plot + geom_jitter(shape = 21, alpha = 0.3)
  # geom_jitter() & geom_point(posiition = 'jitter') are the same.
  # Similarly, geom_point() equals to geom_point(position = 'identity') .
```

##### **And not working on bigger data**    
```{r}
plot2 <- ggplot(diamonds, aes(x = carat, y = price))
  plot2 + geom_point(alpha = 0.1)
  plot2 + geom_jitter(alpha = 0.1)
```

#### **Bar Plot: Stack, Fill or Dodge?**   
Besides jittering the plot, bar plots suffer from their own issues of overplotting.   
They are stack, fill & dodge.   
In this example, it seems that ```position = 'dodge'``` is the best choice. 
```{r}
plot3 <- ggplot(mtcars, aes(x = factor(cyl), fill = factor(am)))
  plot3 + geom_bar()# The default postition is 'stack'.
  plot3 + geom_bar(position = 'fill')
  plot3 + geom_bar(position = 'dodge')
```

## Scale Function   

All the aesthetics we saw earlier have an associated scale function.    
The third part must match the type of data we are using.        
The first argument is always the name of the scale, after that the most common are limits, breaks, expand, and labels.    

* scale_x...    
    + ```scale_x_continuous('Length', limits = c(2, 8), breaks = seq(0, 8, by = 2), expand = c(0, 0))```    
        + Limits: describe the scale's limits.     
        + Breaks: control the breaks in the guide.    
        + Expand: expand the range of the scales so that there is a small gap between the data and the axes.    
* scale_y...      
* scale_color...    
    + ```scale_color_discrete('Species', labels = c('Setosa', 'Versicolor', 'Virginica'))```     
        +  Labels: adjust the category names.   
* scale_fill...     
* scale_shape...    
* scale_linetype...   

Let's redrawn the plot about ```iris.wide``` and ```mtcars``` above by adding more commands.
```{r}
plot + 
  scale_x_continuous('Length', limits = c(0, 8), breaks = seq(0, 8, by = 2), expand = c(0, 0)) +
  scale_fill_discrete('Species', labels = c('Setosa', 'Versicolor', 'Virginica')) +
  geom_jitter(shape = 21, alpha = 0.3)

plot3 +
  scale_x_discrete("Cylinders") +
  scale_y_continuous("Number") +
  scale_fill_manual('Transmission', 
                    values = c("#E41A1C", "#377EB8"),
                    labels = c("Manual", "Automatic")) +
  geom_bar(position = "dodge")
```

## Which Kind of Aesthetics?
#### **For Continuous Variables**
<div style="width:600px; height:400px">    
![](D:\Desktop\2.png) 

#### **For Categorical Variables**
<div style="width:600px; height:700px">    
![](D:\Desktop\3.png) 

#### **Deal with Overplotting**
You'll have to deal with overplotting when you have:    

* Large datasets.   
* Imprecise data and so points are not clearly separated on your plot (e.g. ```iris``` above).    
* Interval data (i.e. data appears at fixed values).   
* Aligned data values on a single axis.   

Common Solutions:   

* Use alpha blending (i.e. adding transparency).    
* Use hollow shapes.    
* Use geom_jitter() if it helps.    

```{r}
plot4 <- ggplot(mtcars, aes(x = wt, y = mpg, col = factor(cyl)))
plot5 <- ggplot(diamonds[sample(nrow(diamonds), 800), ], aes(x = clarity, y = carat, col = price))# Random pick 800 rows in 'diamonds'.

# Hollow circles - an improvement
plot4 + geom_point(shape = 1, size = 4) + scale_color_discrete('Cylinders')
# Add transparency - great
plot4 + geom_point(alpha = 0.3, size = 4) + scale_color_discrete('Cylinders')

# Scatter plot: clarity (x), carat (y), price (color)
plot5 + geom_point(alpha = 0.5)
# Dot plot with jittering
plot5 + geom_point(position = 'jitter', alpha = 0.5)
```

<h2 id = '4'></h2>
# **Geometries**